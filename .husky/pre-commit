#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."
echo ""

# Run lint-staged for staged files
npx lint-staged

# Check for secrets in staged files
echo "ğŸ”’ Checking for secrets..."
git diff --cached --name-only | while read file; do
  if [ -f "$file" ]; then
    case "$file" in
      .husky/pre-commit|package.json|package-lock.json|yarn.lock|pnpm-lock.yaml|*/package.json|*/package-lock.json|*.md|*.MD|*.env.example|*.example|*.example.*|*__tests__*|*test*.ts|*test*.js|*spec*.ts|*spec*.js)
        continue
        ;;
    esac
    # Check for common secret patterns
    if grep -iE "(api_key|apikey|secret|private_key).*['\"].*['\"]" "$file"; then
      echo "âŒ Error: Potential secret found in $file"
      echo "Please remove hardcoded secrets before committing."
      exit 1
    fi
  fi
done

# Check for .env files (should never be committed)
if git diff --cached --name-only | grep -E "^\.env$|^apps/.*\.env$|^frontend_new/\.env$"; then
  echo "âŒ Error: .env file found in staged files"
  echo "Please never commit .env files with secrets."
  echo "Use .env.example instead."
  exit 1
fi

echo "âœ… Pre-commit checks passed!"

