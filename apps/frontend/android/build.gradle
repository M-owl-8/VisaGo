// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
    ext {
        buildToolsVersion = findProperty('android.buildToolsVersion') ?: '34.0.0'
        minSdkVersion = Integer.parseInt(findProperty('android.minSdkVersion') ?: '24')
        compileSdkVersion = Integer.parseInt(findProperty('android.compileSdkVersion') ?: '34')
        targetSdkVersion = Integer.parseInt(findProperty('android.targetSdkVersion') ?: '34')
        kotlinVersion = findProperty('android.kotlinVersion') ?: '1.8.10'
        frescoVersion = findProperty('expo.frescoVersion') ?: '2.5.0'

        // We use NDK 23 which has both M1 support and is the side-by-side NDK version from AGP.
        ndkVersion = "23.1.7779620"
    }
    repositories {
        google()
        mavenCentral()
        maven { url("${rootDir}/../node_modules/jsc-android/dist") }
    }
    dependencies {
        classpath('com.android.tools.build:gradle:8.2.1')
        classpath('org.jetbrains.kotlin:kotlin-gradle-plugin:1.8.10')
        classpath('com.facebook.react:react-native-gradle-plugin')
    }
}

// Apply the custom Expo fix plugin
apply plugin: 'expo-fix'

allprojects {
    repositories {
        maven {
            // All of React Native (JS, Obj-C sources, Android binaries) is installed from npm
            url(new File(['node', '--print', "require.resolve('react-native/package.json')"].execute(null, rootDir).text.trim(), '../android'))
        }
        maven {
            // Android JSC is installed from npm
            url(new File(['node', '--print', "require.resolve('jsc-android/package.json')"].execute(null, rootDir).text.trim(), '../dist'))
        }

        google()
        mavenCentral()
        maven { url 'https://www.jitpack.io' }
    }
}

// Apply configuration to all subprojects (including expo modules)
subprojects {
    // Use beforeEvaluate to run before the build.gradle is parsed
    beforeEvaluate {
        // Ensure compileSdkVersion is set early
        if (it.hasProperty('android')) {
            def android = it.android
            if (!android.compileSdkVersion) {
                android.compileSdkVersion rootProject.ext.compileSdkVersion
            }
        }
    }
    
    // Also apply afterEvaluate for additional fixes
    afterEvaluate {
        if (it.hasProperty('android')) {
            def android = it.android
            
            // Set compileSdkVersion if still not set
            if (!android.compileSdkVersion) {
                android.compileSdkVersion rootProject.ext.compileSdkVersion
            }
            
            // Enable buildConfig for all modules
            try {
                if (!android.buildFeatures || !android.buildFeatures.hasProperty('buildConfig') || android.buildFeatures.buildConfig == false) {
                    android.buildFeatures.buildConfig = true
                }
            } catch (Exception e) {
                try {
                    android.buildFeatures {
                        buildConfig = true
                    }
                } catch (Exception e2) {
                    // Silently ignore if we can't set it
                }
            }
        }
    }
}

// Gradle initialization to fix expo modules at project evaluation time
gradle.projectsEvaluated {
    rootProject.allprojects { project ->
        def expoModules = ['expo', 'expo-modules-core', 'expo-application', 'expo-constants', 
                          'expo-file-system', 'expo-font', 'expo-keep-awake', 'react-native']
        
        if (project.name in expoModules) {
            if (project.hasProperty('android')) {
                try {
                    project.android.buildFeatures.buildConfig = true
                    if (!project.android.compileSdkVersion) {
                        project.android.compileSdkVersion rootProject.ext.compileSdkVersion
                    }
                } catch (Exception e) {
                    // Silently continue
                }
            }
        }
    }
}
