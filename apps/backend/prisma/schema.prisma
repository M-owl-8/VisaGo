// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                     String            @id @default(cuid())
  email                  String            @unique
  googleId               String?           @unique
  firstName              String?
  lastName               String?
  phone                  String?
  passwordHash           String?
  avatar                 String?
  language               String            @default("en")
  timezone               String?
  currency               String            @default("USD")
  emailVerified          Boolean           @default(false)
  bio                    String? // JSON string containing questionnaire data
  questionnaireCompleted Boolean           @default(false)
  role                   String            @default("user")
  resetToken             String?
  resetTokenExpiry       DateTime?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  // ... rest of the model stays the same
  // Relations
  visaApplications       VisaApplication[]
  documents              UserDocument[]
  payments               Payment[]
  preferences            UserPreferences?
  activityLog            ActivityLog[]
  chatSessions           ChatSession[]
  chatMessages           ChatMessage[]
  aiUsageMetrics         AIUsageMetrics[]
  emailLogs              EmailLog[]
  deviceTokens           DeviceToken[]
  notificationLogs       NotificationLog[]
  applications           Application[]

  @@index([email])
  @@index([googleId])
  @@index([role])
}

model UserPreferences {
  id                   String   @id @default(cuid())
  userId               String   @unique
  notificationsEnabled Boolean  @default(true)
  emailNotifications   Boolean  @default(true)
  pushNotifications    Boolean  @default(true)
  paymentConfirmations Boolean  @default(true)
  documentUpdates      Boolean  @default(true)
  visaStatusUpdates    Boolean  @default(true)
  dailyReminders       Boolean  @default(true)
  newsUpdates          Boolean  @default(false)
  twoFactorEnabled     Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Country {
  id           String   @id @default(cuid())
  name         String   @unique
  code         String   @unique // ISO 3166-1 alpha-2
  flagEmoji    String
  description  String?
  requirements String? // JSON field with detailed requirements
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  visaTypes        VisaType[]
  applications     VisaApplication[]
  userApplications Application[]

  @@index([code])
  @@index([name])
}

model VisaType {
  id             String   @id @default(cuid())
  countryId      String
  name           String // e.g., "Tourist Visa", "Work Visa"
  description    String?
  processingDays Int // Average processing time
  validity       String // Duration of visa validity
  fee            Float // In USD
  requirements   String // JSON with requirement details
  /// @deprecated Legacy field. Do not use as a primary rules source.
  /// VisaRuleSet is the canonical source for document requirements.
  documentTypes  String // JSON array of required document types
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  country          Country           @relation(fields: [countryId], references: [id], onDelete: Cascade)
  applications     VisaApplication[]
  userApplications Application[]

  @@unique([countryId, name])
  @@index([countryId])
}

model VisaApplication {
  id                 String    @id @default(cuid())
  userId             String
  countryId          String
  visaTypeId         String
  status             String    @default("draft") // draft, submitted, approved, rejected, expired
  progressPercentage Int       @default(0)
  notes              String?
  submissionDate     DateTime?
  approvalDate       DateTime?
  expiryDate         DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  user         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  country      Country               @relation(fields: [countryId], references: [id])
  visaType     VisaType              @relation(fields: [visaTypeId], references: [id])
  documents    UserDocument[]
  payment      Payment?
  checkpoints  Checkpoint[]
  checkResults DocumentCheckResult[] // Phase 3: Document check results
  riskExplanation   VisaRiskExplanation?
  checklistFeedback ChecklistFeedback[]

  @@unique([userId, countryId, visaTypeId])
  @@index([userId])
  @@index([status])
}

model Checkpoint {
  id            String    @id @default(cuid())
  applicationId String
  title         String // e.g., "Document Verification", "Interview Scheduled"
  description   String?
  isCompleted   Boolean   @default(false)
  order         Int
  completedAt   DateTime?
  dueDate       DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  application VisaApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([isCompleted])
}

model DocumentType {
  id               String   @id @default(cuid())
  name             String   @unique // e.g., "Passport", "Bank Statement"
  description      String?
  supportedFormats String // JSON array ["pdf", "jpg", "png"]
  maxFileSize      Int // in MB
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([name])
}

model UserDocument {
  id                String    @id @default(cuid())
  userId            String
  applicationId     String
  documentName      String
  documentType      String // Type of document (e.g., "passport", "bank_statement")
  fileUrl           String // Firebase Storage URL
  fileName          String
  fileSize          Int // In bytes
  uploadedAt        DateTime  @default(now())
  status            String    @default("pending") // pending, verified, rejected
  verificationNotes String?
  expiryDate        DateTime?
  verifiedByAI      Boolean?  @default(false)
  aiConfidence      Float? // 0-1
  aiNotesUz         String?
  aiNotesRu         String?
  aiNotesEn         String?
  // Phase 3: Document classification fields
  // TODO: classification fields were removed from DB; reintroduce carefully with a proper migration if needed.
  // classifiedType        String?   // e.g. "passport", "bank_statement", "employment_letter"
  // classificationSource  String?   // e.g. "ai", "manual"
  // classificationScore   Float?    // confidence score 0-1
  // extractedText         String?   // extracted/ocr text (for doc-check)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  application VisaApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  // checkResults      DocumentCheckResult[] // Phase 3: Document check results - commented out as model doesn't exist
  // @@index([classifiedType]) // Removed - column doesn't exist in DB

  @@index([userId])
  @@index([applicationId])
  @@index([status])
}

model Payment {
  id                 String    @id @default(cuid())
  userId             String
  applicationId      String    @unique
  amount             Float // In USD
  refundedAmount     Float     @default(0) // Amount refunded
  currency           String    @default("USD")
  status             String    @default("pending") // pending, completed, failed, refunded, partially_refunded
  paymentMethod      String // payme, uzum, click, stripe, card
  transactionId      String?   @unique
  orderId            String?
  paymentGatewayData String? // JSON with gateway response
  paidAt             DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  application VisaApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  refunds     Refund[]

  @@index([userId])
  @@index([status])
}

model WebhookIdempotency {
  id            String    @id @default(cuid())
  fingerprint   String    @unique // SHA256 hash of webhook unique identifier
  webhookId     String // Unique ID from payment gateway
  paymentMethod String // payme, click, uzum, stripe
  transactionId String // Payment transaction ID
  eventType     String // Type of webhook event
  signature     String // Webhook signature for verification
  body          String // Full webhook payload (JSON string for SQLite compatibility)
  status        String    @default("pending") // pending, processed, failed
  attempts      Int       @default(0) // Number of processing attempts
  lastAttemptAt DateTime?
  processedAt   DateTime?
  error         String? // Error message if processing failed
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([paymentMethod])
  @@index([transactionId])
  @@index([status])
  @@index([createdAt])
}

model AdminLog {
  id          String   @id @default(cuid())
  action      String // create, update, delete, approve, reject
  entityType  String // User, VisaApplication, Payment, etc.
  entityId    String
  changes     String? // JSON with before/after
  performedBy String // Admin user ID
  reason      String?
  createdAt   DateTime @default(now())

  @@index([createdAt])
  @@index([entityType])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String // login, document_upload, application_submit
  details   String? // JSON with additional details
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// ============================================================================
// AI/RAG MODELS
// ============================================================================

model Document {
  id          String   @id @default(cuid())
  title       String
  content     String
  type        String // visa_requirement, guide, faq, requirement_detail
  countryId   String?
  visaTypeId  String?
  source      String? // Internal, External URL, User Uploaded
  metadata    String? // JSON with additional metadata
  embedding   String? // Vector embedding as JSON (for RAG)
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([isPublished])
  @@index([countryId])
  @@index([visaTypeId])
}

model RAGChunk {
  id         String   @id @default(cuid())
  documentId String
  content    String
  chunkIndex Int // Position in document
  embedding  String? // Vector embedding as JSON
  metadata   String? // JSON with source info
  createdAt  DateTime @default(now())

  @@index([documentId])
  @@index([chunkIndex])
}

model ChatSession {
  id            String        @id @default(cuid())
  userId        String
  applicationId String? // null for general chat
  title         String        @default("New Chat")
  systemPrompt  String        @default("You are a helpful visa assistant for VisaBuddy. Provide accurate information about visa requirements and processes.")
  messages      ChatMessage[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([applicationId])
}

model ChatMessage {
  id           String   @id @default(cuid())
  sessionId    String
  userId       String
  role         String // "user" or "assistant"
  content      String
  sources      String? // JSON array of RAG sources/references with URLs
  model        String   @default("gpt-4")
  tokensUsed   Int      @default(0)
  responseTime Int? // milliseconds
  feedback     String? // thumbs_up, thumbs_down, detailed_feedback
  createdAt    DateTime @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@index([createdAt])
}

model AIUsageMetrics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime
  totalRequests   Int      @default(0)
  totalTokens     Int      @default(0)
  totalCost       Float    @default(0)
  avgResponseTime Int      @default(0)
  errorCount      Int      @default(0)
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  userId    String? // null for anonymous events
  eventType String // signup, visa_selected, payment_completed, document_uploaded, chat_message, login, app_opened
  source    String? // email, google, organic, referral
  metadata  String? // JSON with additional event data (country, visa_type, amount, etc)
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([createdAt])
  @@index([source])
}

model DailyMetrics {
  id                  String   @id @default(cuid())
  date                DateTime @unique // YYYY-MM-DD format
  totalSignups        Int      @default(0)
  totalVisaSelections Int      @default(0)
  totalPayments       Int      @default(0)
  totalRevenue        Float    @default(0) // in USD
  totalDocuments      Int      @default(0)
  totalMessages       Int      @default(0)
  activeUsers         Int      @default(0)
  newUsers            Int      @default(0)
  conversionRate      Float    @default(0) // signup to payment
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([date])
}

// ============================================================================
// NOTIFICATION & LOGGING MODELS
// ============================================================================

model EmailLog {
  id             String    @id @default(cuid())
  userId         String
  recipientEmail String
  subject        String
  templateName   String?
  type           String? // payment_confirmation, payment_failed, visa_status_update, welcome, etc
  status         String    @default("pending") // pending, sent, failed
  error          String? // Error message if failed
  sentAt         DateTime?
  failureReason  String?
  metadata       String? // JSON with additional context
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model DeviceToken {
  id         String    @id @default(cuid())
  userId     String
  deviceId   String? // Device identifier
  token      String    @unique
  platform   String // ios, android, web
  lastUsedAt DateTime?
  isValid    Boolean   @default(true)
  isActive   Boolean   @default(true) // Active status for notifications
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([platform])
}

model NotificationLog {
  id            String    @id @default(cuid())
  userId        String
  deviceTokenId String?
  title         String
  body          String
  type          String // app_update, payment_status, document_request, visa_status
  status        String    @default("pending") // pending, sent, failed
  sentAt        DateTime?
  failureReason String?
  metadata      String? // JSON with additional context
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Refund {
  id              String    @id @default(cuid())
  paymentId       String
  amount          Float
  reason          String
  notes           String? // Additional notes about the refund
  status          String    @default("pending") // pending, processing, completed, failed
  gatewayRefundId String?   @unique
  failureReason   String?
  initiatedBy     String // user, admin, system
  processedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([status])
  @@index([createdAt])
}

model Application {
  id             String    @id @default(cuid())
  userId         String
  countryId      String
  visaTypeId     String
  status         String    @default("draft") // draft, submitted, under_review, approved, rejected
  submissionDate DateTime?
  approvalDate   DateTime?
  expiryDate     DateTime?
  metadata       String? // JSON with application-specific data
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  country           Country            @relation(fields: [countryId], references: [id])
  visaType          VisaType           @relation(fields: [visaTypeId], references: [id])
  documentChecklist DocumentChecklist?

  @@index([userId])
  @@index([status])
  @@index([countryId])
  @@index([visaTypeId])
}

model DocumentChecklist {
  id            String    @id @default(cuid())
  applicationId String    @unique
  status        String    @default("processing") // processing, ready, failed
  checklistData String? // JSON string with checklist items
  aiGenerated   Boolean   @default(false)
  generatedAt   DateTime?
  errorMessage  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([status])
}

// ============================================================================
// DOCUMENT CHECK RESULT MODELS (Phase 3)
// ============================================================================

model DocumentCheckResult {
  id              String  @id @default(cuid())
  applicationId   String
  checklistItemId String // ID of checklist item in DocumentChecklist
  documentId      String? // ID of matched uploaded document (nullable if missing)

  status          String // 'OK' | 'MISSING' | 'PROBLEM' | 'UNCERTAIN'
  problemsJson    String? // JSON array of DocCheckProblem
  suggestionsJson String? // JSON array of DocCheckSuggestion
  confidence      Float? // optional AI confidence
  notes           String? // optional human/AI notes
  rawJson         String? @db.Text // Raw GPT-4 response JSON for debugging/audit

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  application VisaApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  // document relation removed - UserDocument doesn't have opposite relation field
  // documentId is kept as plain foreign key field for reference

  @@unique([applicationId, checklistItemId])
  @@index([applicationId])
  @@index([checklistItemId])
  @@index([documentId])
  @@index([status])
}

// ============================================================================
// EMBASSY RULES SYNC PIPELINE MODELS
// ============================================================================

model EmbassySource {
  id            String    @id @default(cuid())
  countryCode   String    // ISO 3166-1 alpha-2 (e.g., "US", "CA")
  visaType      String    // "student" | "tourist" | "work" | etc.
  url           String    // Official embassy/consulate page URL
  name          String?   // Human-readable name (e.g., "US Embassy Tashkent - Student Visa")
  description   String?   // Optional description
  isActive      Boolean   @default(true)
  lastFetchedAt DateTime?
  lastStatus    String?   // "success" | "failed" | "pending"
  lastError     String?   // Error message if last fetch failed
  fetchInterval Int       @default(86400) // Seconds between fetches (default: 24 hours)
  priority      Int       @default(0) // Higher priority sources are fetched first
  metadata      String?   // JSON with additional metadata (selectors, headers, etc.)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  ruleSets VisaRuleSet[]
  pageContents EmbassyPageContent[]
  candidates VisaRuleSetCandidate[]

  @@unique([countryCode, visaType, url])
  @@index([countryCode, visaType])
  @@index([isActive])
  @@index([lastFetchedAt])
  @@index([priority])
}

model VisaRuleSet {
  id            String   @id @default(cuid())
  countryCode   String   // ISO 3166-1 alpha-2
  visaType      String   // "student" | "tourist" | "work" | etc.
  data          Json     // Structured visa rules (see VisaRuleSetData type)
  data_legacy   Json?    // Backup for rollback and migration
  version       Int      @default(1) // Incremental version number
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String   @default("system") // "system" | "admin" | userId
  sourceSummary String?  // Summary of sources used (e.g., "US Embassy Tashkent, VFS Global")
  isApproved    Boolean  @default(false) // Only approved rule sets are used in production
  approvedAt    DateTime?
  approvedBy    String?  // Admin user ID who approved
  rejectionReason String? // If rejected, reason for rejection
  sourceId      String?  // Optional: link to EmbassySource that generated this
  extractionMetadata Json? // Metadata about GPT-4 extraction (tokens, confidence, etc.)

  source EmbassySource? @relation(fields: [sourceId], references: [id], onDelete: SetNull)
  versions VisaRuleVersion[]
  changeLogs VisaRuleSetChangeLog[]
  documentReferences VisaRuleReference[]

  @@unique([countryCode, visaType, version])
  @@index([countryCode, visaType])
  @@index([isApproved])
  @@index([createdAt])
  @@index([version])
}

model VisaRuleVersion {
  id          String   @id @default(cuid())
  ruleSetId  String
  data       Json     // Snapshot of rule set data at this version
  version    Int      // Version number
  changeLog  String?  // Human-readable summary of changes
  createdAt  DateTime @default(now())

  ruleSet VisaRuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)

  @@index([ruleSetId])
  @@index([version])
  @@index([createdAt])
}

model EmbassyPageContent {
  id            String   @id @default(cuid())
  sourceId      String
  url           String
  cleanedText   String   @db.Text
  html          String?  @db.Text
  title         String?
  status        String   @default("success")
  httpStatus    Int?
  errorMessage  String?
  metadata      Json?
  fetchedAt     DateTime @default(now())

  source EmbassySource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  candidates VisaRuleSetCandidate[]

  @@index([sourceId])
  @@index([url])
  @@index([fetchedAt])
  @@index([status])
}

model VisaRuleSetCandidate {
  id            String   @id @default(cuid())
  sourceId      String
  pageContentId String?
  countryCode   String
  visaType       String
  data           Json
  confidence     Float?
  extractionMetadata Json?
  status         String   @default("pending")
  reviewedBy     String?
  reviewedAt     DateTime?
  reviewNotes    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  source EmbassySource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  pageContent EmbassyPageContent? @relation(fields: [pageContentId], references: [id], onDelete: SetNull)

  @@index([sourceId])
  @@index([countryCode, visaType])
  @@index([status])
  @@index([createdAt])
}

model VisaRuleSetChangeLog {
  id            String   @id @default(cuid())
  ruleSetId     String
  changeType    String
  changedBy     String?
  changeDetails Json?
  description   String?
  createdAt     DateTime @default(now())

  ruleSet VisaRuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)

  @@index([ruleSetId])
  @@index([changeType])
  @@index([createdAt])
}

model VisaRiskExplanation {
  id            String   @id @default(cuid())
  applicationId String   @unique
  userId        String
  countryCode   String
  visaType      String
  riskLevel     String   // "low" | "medium" | "high"
  summaryEn     String
  summaryUz     String
  summaryRu     String
  recommendations Json   // JSON array of recommendation objects
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  application VisaApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([userId])
  @@index([countryCode, visaType])
  @@index([riskLevel])
  @@index([createdAt])
}

model ChecklistFeedback {
  id              String   @id @default(cuid())
  applicationId   String
  userId          String
  countryCode     String
  visaType        String
  checklistSnapshot Json   // JSON snapshot of checklist at time of feedback
  feedbackType    String   // "missing_docs" | "unnecessary_docs" | "other"
  feedbackText    String
  createdAt       DateTime @default(now())

  application VisaApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([userId])
  @@index([countryCode, visaType])
  @@index([feedbackType])
  @@index([createdAt])
}

// ============================================================================
// GLOBAL DOCUMENT CATALOG (Phase 1)
// ============================================================================

model DocumentCatalog {
  id                   String   @id @default(cuid())
  documentType         String   @unique
  nameEn               String
  nameUz               String
  nameRu               String
  descriptionEn        String   @db.Text
  descriptionUz        String   @db.Text
  descriptionRu        String   @db.Text
  defaultCategory      String
  group                String
  validityRequirements String?  @db.Text
  formatRequirements   String?  @db.Text
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  ruleReferences VisaRuleReference[]

  @@index([documentType])
  @@index([group])
  @@index([isActive])
}

model VisaRuleReference {
  id                  String   @id @default(cuid())
  ruleSetId           String
  documentId          String
  condition           String?
  categoryOverride    String?
  descriptionOverride String? @db.Text
  createdAt           DateTime @default(now())

  ruleSet  VisaRuleSet    @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
  document DocumentCatalog @relation(fields: [documentId], references: [id])

  @@unique([ruleSetId, documentId])
  @@index([ruleSetId])
  @@index([documentId])
}
