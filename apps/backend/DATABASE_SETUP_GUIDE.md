# VisaBuddy Backend - Flexible Database Setup Guide

## üéØ Overview

This backend now **automatically detects** which database to use:

- **Local Development:** SQLite (file-based, no setup needed)
- **Production (Railway):** PostgreSQL (managed by Railway)

No manual switching required! ‚ú®

---

## üîÑ How Auto-Detection Works

### The Magic: `prisma/schema-selector.js`

This script runs **automatically before every Prisma command** and:

1. Reads `DATABASE_URL` environment variable
2. Detects if it's PostgreSQL (`postgresql://...`) or SQLite (`file:...`)
3. Copies the appropriate schema:
   - `schema.postgresql.prisma` ‚Üí `schema.prisma` (if PostgreSQL)
   - `schema.sqlite.prisma` ‚Üí `schema.prisma` (if SQLite)
4. Prisma then uses the correct schema

### When It Runs:

Automatically runs before:

- `npm run dev`
- `npm run build`
- `npm run start`
- `npm run db:generate`
- `npm run db:migrate`
- `npm run db:studio`
- `npm run db:seed`
- `npm run db:reset`

---

## üè† Local Development Setup

### 1. Environment Setup

Create `apps/backend/.env`:

```bash
# Database (SQLite for local development)
DATABASE_URL=file:./prisma/dev.db

# Other variables...
JWT_SECRET=your-secret-key-at-least-32-characters-long
NODE_ENV=development
```

### 2. Initialize Database

```bash
cd apps/backend

# Generate Prisma client (auto-selects SQLite schema)
npm run db:generate

# Push schema to database
npx prisma db push

# Seed the database
npm run db:seed
```

### 3. Start Development Server

```bash
npm run dev
```

Output:

```
üîÑ Auto-selecting Prisma schema...
   DATABASE_URL: file:./prisma/dev.db...
   Database type: SQLite
   Using schema: schema.sqlite.prisma

‚úÖ Schema file updated successfully
```

---

## ‚òÅÔ∏è Production (Railway) Setup

### Railway Automatically Uses PostgreSQL

When deployed to Railway:

1. Railway provides `DATABASE_URL` as PostgreSQL connection string
2. `schema-selector.js` detects PostgreSQL
3. Uses `schema.postgresql.prisma`
4. Everything works automatically ‚úÖ

### Check Railway Logs:

```
üîÑ Auto-selecting Prisma schema...
   DATABASE_URL: postgresql://user:pass@host...
   Database type: PostgreSQL
   Using schema: schema.postgresql.prisma

‚úÖ Schema file updated successfully
```

---

## üìÅ Schema Files

### `schema.prisma` (Auto-generated)

- **DO NOT EDIT THIS FILE**
- Generated automatically by `schema-selector.js`
- Overwritten before each Prisma command
- Not committed to git (in `.gitignore`)

### `schema.postgresql.prisma` (Source for Production)

- PostgreSQL-specific schema
- Edit this for production schema changes
- Committed to git ‚úÖ

### `schema.sqlite.prisma` (Source for Local Dev)

- SQLite-specific schema
- Edit this for local development schema changes
- Committed to git ‚úÖ
- **Note:** Keep in sync with PostgreSQL schema (same models, different provider)

---

## üîß Common Tasks

### View Database

**SQLite (Local):**

```bash
npm run db:studio
# Opens Prisma Studio at http://localhost:5555
```

**PostgreSQL (Railway):**
Use Railway dashboard ‚Üí Database ‚Üí Data tab

### Reset Database

**Local:**

```bash
npm run db:reset
npm run db:seed
```

**Production:**
Don't reset production database! Use migrations instead.

### Create Migration

**For Production (PostgreSQL):**

1. Edit `schema.postgresql.prisma`
2. Create migration:
   ```bash
   npx prisma migrate dev --name your_migration_name
   ```
3. Commit migration files to git
4. Railway auto-applies on deploy

**For Local (SQLite):**

```bash
npx prisma db push
```

(SQLite doesn't use migration files)

---

## üö® Troubleshooting

### "Error: provider postgresql/sqlite mismatch"

**Cause:** Prisma client was generated with wrong schema

**Fix:**

```bash
npm run db:generate
```

This regenerates the client with the correct schema.

### "Cannot find module '@prisma/client'"

**Fix:**

```bash
npm install
npm run db:generate
```

### "Database file not found" (SQLite)

**Fix:**

```bash
# Create/update database
npx prisma db push

# Seed it
npm run db:seed
```

### Manual Schema Selection (if needed)

```bash
# Force SQLite
DATABASE_URL=file:./prisma/dev.db node prisma/schema-selector.js

# Force PostgreSQL
DATABASE_URL=postgresql://... node prisma/schema-selector.js
```

---

## üìä Verifying Setup

### Check Active Schema:

```bash
cat prisma/schema.prisma | grep "provider"
```

Should show:

- `provider = "sqlite"` for local
- `provider = "postgresql"` for production

### Test Database Connection:

```bash
npx prisma db pull
```

Should connect successfully without errors.

---

## üéì Best Practices

1. **Never edit `schema.prisma` directly**
   - Edit `schema.postgresql.prisma` or `schema.sqlite.prisma`
   - Let the auto-selector handle the rest

2. **Keep schemas in sync**
   - Both SQLite and PostgreSQL schemas should have same models
   - Only difference: `provider` line

3. **Use migrations in production**
   - Always use `prisma migrate` for PostgreSQL
   - Test migrations locally first

4. **Seed data consistently**
   - Same seed script works for both SQLite and PostgreSQL
   - Run `npm run db:seed` after schema changes

---

## üîÆ Future-Proof

This setup works with:

- ‚úÖ Local development (SQLite)
- ‚úÖ Railway (PostgreSQL)
- ‚úÖ Heroku (PostgreSQL)
- ‚úÖ Vercel (PostgreSQL with connection pooling)
- ‚úÖ AWS RDS (PostgreSQL)
- ‚úÖ Docker (both SQLite and PostgreSQL)

Just set `DATABASE_URL` and it auto-configures! üöÄ

---

**Last Updated:** 2025-11-18


