name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.10'

jobs:
  # ============================================================================
  # PRE-DEPLOYMENT CHECKS
  # ============================================================================
  pre-deploy-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install backend dependencies
        working-directory: apps/backend
        run: npm ci

      - name: Generate Prisma Client
        working-directory: apps/backend
        run: npm run db:generate

      - name: Run backend tests
        working-directory: apps/backend
        run: npm test
        env:
          DATABASE_URL: file:./test.db
          JWT_SECRET: test-secret-for-ci-pipeline-only-not-for-production-use
          NODE_ENV: test

      - name: Build backend
        working-directory: apps/backend
        run: npm run build

      - name: Check for build artifacts
        run: |
          if [ ! -d "apps/backend/dist" ]; then
            echo "‚ùå Backend build failed - dist folder not found"
            exit 1
          fi
          echo "‚úÖ Backend build successful"

  # ============================================================================
  # DEPLOY TO RAILWAY (Manual or via Railway CLI)
  # ============================================================================
  deploy-info:
    name: Deployment Information
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    
    steps:
      - name: Display deployment info
        run: |
          echo "üöÄ Deployment to Railway"
          echo "========================"
          echo ""
          echo "‚úÖ Pre-deployment checks passed"
          echo ""
          echo "üìù Next Steps:"
          echo "1. Railway will automatically detect this push and deploy"
          echo "2. Backend service: Uses nixpacks.toml in apps/backend/"
          echo "3. AI Service: Uses nixpacks.toml in apps/ai-service/"
          echo "4. Database migrations will run automatically (via start script)"
          echo ""
          echo "üîç Monitor deployment:"
          echo "- Railway Dashboard: https://railway.app/dashboard"
          echo "- Check service logs for any errors"
          echo "- Verify health check: /health endpoint"
          echo ""
          echo "‚ö†Ô∏è  Important:"
          echo "- Ensure all environment variables are set in Railway"
          echo "- Verify database migrations completed successfully"
          echo "- Test critical endpoints after deployment"

  # ============================================================================
  # POST-DEPLOYMENT HEALTH CHECKS
  # ============================================================================
  post-deploy-health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: deploy-info
    
    steps:
      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting 2 minutes for Railway deployment to complete..."
          sleep 120

      - name: Health check - Backend
        run: |
          echo "üè• Checking backend health..."
          # Replace with your actual Railway backend URL
          # curl -f https://your-backend.railway.app/health || exit 1
          echo "‚ö†Ô∏è  Skipping health check - configure your Railway URL in this workflow"
        continue-on-error: true

      - name: Health check - AI Service
        run: |
          echo "üè• Checking AI service health..."
          # Replace with your actual Railway AI service URL
          # curl -f https://your-ai-service.railway.app/health || exit 1
          echo "‚ö†Ô∏è  Skipping health check - configure your Railway URL in this workflow"
        continue-on-error: true

      - name: Deployment summary
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          echo ""
          echo "‚úÖ Pre-deployment checks: PASSED"
          echo "‚úÖ Build verification: PASSED"
          echo "‚ö†Ô∏è  Health checks: CONFIGURE URLS"
          echo ""
          echo "üéâ Deployment workflow completed!"
          echo ""
          echo "üìù Manual verification required:"
          echo "1. Check Railway dashboard for deployment status"
          echo "2. Verify all services are running"
          echo "3. Check service logs for errors"
          echo "4. Test critical user flows"
          echo "5. Monitor error rates in Sentry (if configured)"

  # ============================================================================
  # NOTIFICATION (Optional - can integrate with Slack, Discord, etc.)
  # ============================================================================
  notify:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: post-deploy-health-check
    if: always()
    
    steps:
      - name: Deployment notification
        run: |
          echo "üì¢ Deployment Notification"
          echo "========================="
          echo ""
          if [ "${{ needs.post-deploy-health-check.result }}" == "success" ]; then
            echo "‚úÖ Deployment completed successfully!"
          else
            echo "‚ùå Deployment may have issues - check logs"
          fi
          echo ""
          echo "üí° To integrate with Slack/Discord:"
          echo "- Add webhook URL to GitHub Secrets"
          echo "- Use webhook action to send notifications"
